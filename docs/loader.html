---

title: Loader


keywords: fastai
sidebar: home_sidebar

summary: "Functions for finding and loading image files and saved embeddings"
description: "Functions for finding and loading image files and saved embeddings"
nb_path: "01_loader.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 01_loader.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="File-manipulation">File manipulation<a class="anchor-link" href="#File-manipulation"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>NB: A lot of this implementation is too specific, especially the slugified filenames being used for dictionary IDs. Should be replaced with a better database implementation.</strong></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="slugify" class="doc_header"><code>slugify</code><a href="https://github.com/deepfates/memery/tree/main/memery/loader.py#L12" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>slugify</code>(<strong><code>filepath</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_image_files" class="doc_header"><code>get_image_files</code><a href="https://github.com/deepfates/memery/tree/main/memery/loader.py#L15" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_image_files</code>(<strong><code>path</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_valid_images" class="doc_header"><code>get_valid_images</code><a href="https://github.com/deepfates/memery/tree/main/memery/loader.py#L19" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_valid_images</code>(<strong><code>path</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="verify_image" class="doc_header"><code>verify_image</code><a href="https://github.com/deepfates/memery/tree/main/memery/loader.py#L24" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>verify_image</code>(<strong><code>f</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Demonstrating the usage here, not a great test though:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./images&#39;</span><span class="p">)</span>


<span class="n">filepaths</span> <span class="o">=</span> <span class="n">get_image_files</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>

<span class="nb">len</span><span class="p">(</span><span class="n">filepaths</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>85it [00:00, 59419.31it/s]
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>82</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">filepaths</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[(PosixPath(&#39;images/Wholesome-Meme-3.jpg&#39;), &#39;Wholesome-Meme-3_1621298477&#39;),
 (PosixPath(&#39;images/Wholesome-Meme-44.png&#39;), &#39;Wholesome-Meme-44_1621298480&#39;),
 (PosixPath(&#39;images/Wholesome-Meme-69.jpg&#39;), &#39;Wholesome-Meme-69_1621298481&#39;)]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Loaders">Loaders<a class="anchor-link" href="#Loaders"> </a></h2><p>So we have a list of paths and slugified filenames from the folder. We want to see if there's an archive, so that we don't have to recalculate tensors for images we've seen before. Then we want to pass that directly to the indexer, but send the new images through the crafter and encoder first.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We want to use the GPU, if possible, for all the pyTorch functions. But if we can't get access to it we need to fallback to CPU. Either way we call it <a href="/memery/encoder.html#device"><code>device</code></a> and pass it to each function in the executors that use torch.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>device(type=&#39;cuda&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <a href="/memery/loader.html#archive_loader"><code>archive_loader</code></a> is only called in <code>indexFlow</code>. It takes the list of image files and the folder they're in (and the torch device), opens an archive if there is one</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="archive_loader" class="doc_header"><code>archive_loader</code><a href="https://github.com/deepfates/memery/tree/main/memery/loader.py#L43" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>archive_loader</code>(<strong><code>filepaths</code></strong>, <strong><code>root</code></strong>, <strong><code>device</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <a href="/memery/loader.html#db_loader"><code>db_loader</code></a> takes a location and returns either the archive dictionary or an empty dictionary. Decomposed to its own function so it can be called separately from <a href="/memery/loader.html#archive_loader"><code>archive_loader</code></a> or <code>queryFlow</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="db_loader" class="doc_header"><code>db_loader</code><a href="https://github.com/deepfates/memery/tree/main/memery/loader.py#L56" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>db_loader</code>(<strong><code>dbpath</code></strong>, <strong><code>device</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The library <code>annoy</code>, <a href="https://github.com/spotify/annoy">Approximate Nearest Neighbors Oh Yeah!</a> allows us to search through vector space for approximate matches instead of exact best-similarity matches. We sacrifice accuracy for speed, so we can search through tens of thousands of images in less than a thousand times the time it would take to search through tens of images. There's got to be a better way to put that.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="treemap_loader" class="doc_header"><code>treemap_loader</code><a href="https://github.com/deepfates/memery/tree/main/memery/loader.py#L71" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>treemap_loader</code>(<strong><code>treepath</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">treepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;images/memery.ann&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">treemap</span> <span class="o">=</span> <span class="n">AnnoyIndex</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="s1">&#39;angular&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="n">treepath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="n">treemap</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">treepath</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">treemap</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here we just test on the local image folder</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">archive_db</span><span class="p">,</span> <span class="n">new_files</span> <span class="o">=</span> <span class="n">archive_loader</span><span class="p">(</span><span class="n">get_image_files</span><span class="p">(</span><span class="n">root</span><span class="p">),</span> <span class="n">root</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>85it [00:00, 53092.46it/s]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Skipping bad file: images/corrupted-file.jpeg
due to &lt;class &#39;PIL.UnidentifiedImageError&#39;&gt;
Skipping bad file: images/.ipynb_checkpoints/corrupted-file-checkpoint.jpeg
due to &lt;class &#39;PIL.UnidentifiedImageError&#39;&gt;
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">archive_db</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_files</span><span class="p">),</span> <span class="n">treemap</span><span class="o">.</span><span class="n">get_n_items</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(80, 0, 80)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dbpath</span> <span class="o">=</span> <span class="n">root</span><span class="o">/</span><span class="s1">&#39;memery.pt&#39;</span>
<span class="c1">#     dbpath_backup = root/&#39;memery.pt&#39;</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">db_loader</span><span class="p">(</span><span class="n">dbpath</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

<span class="n">current_slugs</span> <span class="o">=</span> <span class="p">[</span><span class="n">slug</span> <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">slug</span> <span class="ow">in</span> <span class="n">filepaths</span><span class="p">]</span>    
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">archive_db</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="n">db</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;slug&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">current_slugs</span><span class="p">}</span>  
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">archive_db</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>80</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

